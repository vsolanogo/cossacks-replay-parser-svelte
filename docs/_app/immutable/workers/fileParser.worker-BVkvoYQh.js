(function(){"use strict";const V=/(?:^|\s)UID(\d+).*?gMap name (\S+).*?mapsize (\d+).*?terraintype (\d+).*?relieftype (\d+)/s;self.onmessage=j=>{const N=j.data,$=new FileReader;$.onload=z=>{try{let o=z.target?.result??"";o=o.replace(/[^ -~]+/g," ");const b=V.exec(o);if(!b)throw new Error("Game info not found in file");const h={gameId:b[1],gMapName:b[2],mapSize:parseInt(b[3],10),terrainType:parseInt(b[4],10),reliefType:parseInt(b[5],10),players:[]},R=o.match(/\bplayers\b([\s\S]*?)(?=\bplayersinfo\b|\bPatternList\b|\bF\b|$)/);let e=R?R[1]:o;const r=(a,s)=>{const n=new RegExp(s.source,s.flags.includes("g")?s.flags:s.flags+"g").exec(a);if(!n)return{value:"",rest:a};const l=n.index+n[0].length;return{value:n[1],rest:a.slice(l)}},F=[];for(let a=0;a<12;a++){const s=r(e,/cid\s+(-?\d+)/);e=s.rest;const t=r(e,/csid\s+([^\s]+)/);e=t.rest;const n=/name\s+([\s\S]*?)\s+team\b/,c=new RegExp(n.source,"m").exec(e);let i="";if(c){i=c[1].trim();const P=c.index+c[0].length-4;e=e.slice(P)}else{const P=r(e,/name\s+([^\s]+)/);i=P.value||"",e=P.rest}const d=r(e,/team\s+(-?\d+)/);e=d.rest;const u=r(e,/color\s+(-?\d+)/);e=u.rest;const f=r(e,/lanid\s+(-?\d+)/);e=f.rest;const m=r(e,/startx\s+(-?\d+)/);e=m.rest;const p=r(e,/starty\s+(-?\d+)/);e=p.rest;const x=r(e,/aidifficulty\s+(-?\d+)/);e=x.rest;const v=r(e,/bexists\s+(true|false)/);e=v.rest;const I=r(e,/bai\s+(true|false)/);e=I.rest;const M=r(e,/bhuman\s+(true|false)/);e=M.rest;const S=r(e,/bclosed\s+(true|false)/);e=S.rest;const T=r(e,/bready\s+(true|false)/);e=T.rest;const w=r(e,/bloaded\s+(true|false)/);e=w.rest;const E=r(e,/bleave\s+(true|false)/);e=E.rest;const Q={id:a,cid:s.value?parseInt(s.value,10):NaN,csid:t.value||"",name:i||t.value||"",team:d.value?parseInt(d.value,10):0,color:u.value?parseInt(u.value,10):0,lanid:f.value?parseInt(f.value,10):0,startx:m.value?parseInt(m.value,10):0,starty:p.value?parseInt(p.value,10):0,aidifficulty:x.value?parseInt(x.value,10):0,bexists:v.value==="true",bai:I.value==="true",bhuman:M.value==="true",bclosed:S.value==="true",bready:T.value==="true",bloaded:w.value==="true",bleave:E.value==="true"};F.push(Q)}const H=R?R[1]:o,J=/(\* id \d+[\s\S]*?)(?=\* id |\bplayersinfo\b|$)/g;let q;const L=[];for(;(q=J.exec(H))!==null;)L.push(q[1]);const g=(a,s)=>{let t,n;const l=new RegExp(s.source,s.flags.includes("g")?s.flags:s.flags+"g");for(;(t=l.exec(a))!==null;)n=t[1];return n},B=[];for(let a=0;a<L.length;a++){const s=L[a],t=s.match(/\* id (\-?\d+)/),n=g(s,/cid\s+(-?\d+)/g),l=s.match(/csid\s+([^\s]+)/),c=s.match(/name\s+([\s\S]*?)\s+team\b/),i=g(s,/team\s+(-?\d+)/g),d=g(s,/color\s+(-?\d+)/g),u=g(s,/lanid\s+(-?\d+)/g),f=g(s,/startx\s+(-?\d+)/g),m=g(s,/starty\s+(-?\d+)/g),p=g(s,/aidifficulty\s+(-?\d+)/g),x=s.match(/bexists\s+(true|false)/),v=s.match(/bai\s+(true|false)/),I=s.match(/bhuman\s+(true|false)/),M=s.match(/bclosed\s+(true|false)/),S=s.match(/bready\s+(true|false)/),T=s.match(/bloaded\s+(true|false)/),w=s.match(/bleave\s+(true|false)/),E={id:t?parseInt(t[1],10):a,cid:n!=null?parseInt(n,10):NaN,csid:l?l[1]:"",name:c?c[1].trim():l?l[1]:"",team:i!=null?parseInt(i,10):0,color:d!=null?parseInt(d,10):0,lanid:u!=null?parseInt(u,10):0,startx:f!=null?parseInt(f,10):0,starty:m!=null?parseInt(m,10):0,aidifficulty:p!=null?parseInt(p,10):0,bexists:x?x[1]==="true":!1,bai:v?v[1]==="true":!1,bhuman:I?I[1]==="true":!1,bclosed:M?M[1]==="true":!1,bready:S?S[1]==="true":!1,bloaded:T?T[1]==="true":!1,bleave:w?w[1]==="true":!1};B.push(E)}const A=a=>a.reduce((s,t)=>s+(t.bexists?1:0),0),K=A(B)>A(F)?B:F;h.players.push(...K);const C=o.match(/\bplayersinfo\b([\s\S]*?)(?=\bPatternList\b|\bF\b|$)/),G=[];if(C){const a=C[1],s=/(\* sic [\s\S]*?)(?=\* sic |\n\*|$)/g;let t;for(;(t=s.exec(a))!==null;){const n=t[1],l=n.match(/sic\s+(\d+)/),c=n.match(/si1\s+(\d+)/),i=n.match(/si2\s+(\d+)/),d=n.match(/si3\s+(\d+)/),u=n.match(/snc\s+([^\s]+)/),f=n.match(/sn1\s+([^\s]+)/),m=n.match(/sn2\s+([^\s]+)/),p=n.match(/sn3\s+([^\s]+)/);G.push({sic:l?parseInt(l[1],10):0,si1:c?parseInt(c[1],10):0,si2:i?parseInt(i[1],10):0,si3:d?parseInt(d[1],10):0,snc:u?u[1]:"",sn1:f?f[1]:"",sn2:m?m[1]:"",sn3:p?p[1]:""})}}const U=new Set,D=a=>(a??"").replace(/%color\([^\)]*\)%/gi,"").replace(/\s+/g," ").trim().toLowerCase(),k=new Map;h.players.forEach((a,s)=>{const t=D(a.name);k.has(t)||k.set(t,[]),k.get(t).push(s)});let y=0;for(let a=0;a<G.length;a++){const s=G[a];let t=null;const n=D(s.snc);if(n){const l=k.get(n)??[];for(const c of l)if(!U.has(c)){t=c;break}}if(t===null){for(;y<h.players.length&&U.has(y);)y++;y<h.players.length?(t=y,y++):t=null}if(t!==null&&t>=0&&t<h.players.length){const l=h.players[t];l.sic=s.sic,l.si1=s.si1,l.si2=s.si2,l.si3=s.si3,l.snc=s.snc||void 0,l.sn1=s.sn1||void 0,l.sn2=s.sn2||void 0,l.sn3=s.sn3||void 0,U.add(t)}}o="";const O={fileName:N.name,status:"completed",data:h};self.postMessage(O)}catch(o){const b={fileName:N.name,status:"error",data:null,error:o?.message??"Unknown parsing error"};self.postMessage(b)}},$.onerror=()=>{const z={fileName:N.name,status:"error",data:null,error:"Error reading file"};self.postMessage(z)},$.readAsText(N)}})();
